name: Nightly Security Scan

on:
  schedule:
    # Run weekly on Mondays at 02:00 UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:

permissions:
  security-events: write
  contents: read
  issues: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Rebuild and scan latest images
  nightly-scan:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        base: [ubuntu-24.04, ubuntu-22.04, alpine-3.20]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Get Go version from config
        id: go-version
        run: |
          GO_VERSION=$(yq eval '.tools.languages.go.version' configs/image-foundry.yaml)
          echo "go-version=$GO_VERSION" >> $GITHUB_OUTPUT

      - name: Build fresh image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: templates/base/${{ matrix.base }}.Dockerfile
          platforms: linux/amd64
          push: false
          load: true
          tags: nightly-scan:${{ matrix.base }}
          build-args: |
            GO_VERSION=${{ steps.go-version.outputs.go-version }}
          # No cache to ensure fresh packages
          no-cache: true

      - name: Run Trivy vulnerability scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'nightly-scan:${{ matrix.base }}'
          format: 'sarif'
          output: 'trivy-nightly-${{ matrix.base }}.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
          exit-code: '0'

      - name: Run Trivy scan (JSON output)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'nightly-scan:${{ matrix.base }}'
          format: 'json'
          output: 'trivy-nightly-${{ matrix.base }}.json'
          severity: 'CRITICAL,HIGH'

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-nightly-${{ matrix.base }}.sarif'
          category: trivy-nightly-${{ matrix.base }}

      - name: Upload JSON results
        uses: actions/upload-artifact@v4
        with:
          name: trivy-nightly-${{ matrix.base }}
          path: trivy-nightly-${{ matrix.base }}.json

  # Check for outdated dependencies
  dependency-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Check Go dependencies
        run: |
          go list -u -m -json all | go-mod-outdated -update -direct -ci || true
        continue-on-error: true

      - name: Run Nancy (dependency vulnerability check)
        run: |
          go list -json -deps ./... | nancy sleuth || true
        continue-on-error: true

  # Generate comprehensive SBOMs
  generate-sboms:
    runs-on: ubuntu-latest
    needs: nightly-scan
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Get Go version from config
        id: go-version
        run: |
          GO_VERSION=$(yq eval '.tools.languages.go.version' configs/image-foundry.yaml)
          echo "go-version=$GO_VERSION" >> $GITHUB_OUTPUT

      - name: Build images for SBOM
        run: |
          for base in ubuntu-24.04 ubuntu-22.04 alpine-3.20; do
            docker buildx build \
              --platform linux/amd64 \
              --file templates/base/${base}.Dockerfile \
              --build-arg GO_VERSION=${{ steps.go-version.outputs.go-version }} \
              --tag sbom:${base} \
              --load .
          done

      - name: Generate SBOMs
        uses: anchore/sbom-action@v0
        with:
          image: 'sbom:ubuntu-24.04,sbom:ubuntu-22.04,sbom:alpine-3.20'
          format: 'spdx-json,cyclonedx-json'

      - name: Upload SBOMs
        uses: actions/upload-artifact@v4
        with:
          name: nightly-sboms
          path: '*.spdx.json'

  # Check base image updates
  base-image-check:
    runs-on: ubuntu-latest
    steps:
      - name: Check Ubuntu 24.04 updates
        run: |
          docker run --rm ubuntu:24.04 sh -c "apt-get update -qq && apt list --upgradable" || true

      - name: Check Alpine updates
        run: |
          docker run --rm alpine:3.20 sh -c "apk update && apk upgrade --simulate" || true

  # Notify on issues
  notify:
    runs-on: ubuntu-latest
    needs: [nightly-scan, dependency-check]
    if: always()
    steps:
      - name: Create issue if vulnerabilities found
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'security,nightly',
              state: 'open'
            });
            
            const existingIssue = issues.find(i => i.title.includes('Nightly Security Scan'));
            
            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸš¨ Nightly Security Scan - Review Required',
                body: `New vulnerabilities may have been detected in the nightly security scan.
                
                - Run Date: ${new Date().toISOString()}
                - Workflow: ${context.workflow}
                - Run ID: ${context.runId}
                
                Please review the scan results and take appropriate action.`,
                labels: ['security', 'nightly', 'automated']
              });
            }
        continue-on-error: true
