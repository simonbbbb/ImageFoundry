name: PR Check

on:
  pull_request:
    branches: [main, master]
    paths:
      - '**.Dockerfile'
      - '**.yaml'
      - '**.yml'
      - 'cmd/**'
      - 'templates/**'
      - 'scripts/**'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Quick validation
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Get versions from config
        id: versions
        run: |
          GO_VERSION=$(yq eval '.tools.languages.go.version' configs/image-foundry.yaml)
          echo "go-version=$GO_VERSION" >> $GITHUB_OUTPUT

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ steps.versions.outputs.go-version }}

      - name: Build CLI
        run: go build -o foundry ./cmd/foundry

      - name: Validate configs
        run: |
          for config in configs/*.yaml examples/*/image-foundry.yaml; do
            if [ -f "$config" ]; then
              echo "Validating $config..."
              ./foundry validate --config "$config"
            fi
          done

      - name: Lint Dockerfiles
        uses: hadolint/hadolint-action@v3.1.0
        with:
          recursive: true
          dockerfile: "./**/Dockerfile"

  # Build test images (no push)
  build-test:
    runs-on: ubuntu-latest
    needs: validate
    strategy:
      matrix:
        base: [ubuntu-24.04, alpine-3.20]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Get Go version from config
        id: go-version
        run: |
          GO_VERSION=$(yq eval '.tools.languages.go.version' configs/image-foundry.yaml)
          echo "go-version=$GO_VERSION" >> $GITHUB_OUTPUT

      - name: Build test image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: templates/base/${{ matrix.base }}.Dockerfile
          platforms: linux/amd64
          push: false
          load: true
          tags: test:${{ matrix.base }}
          build-args: |
            GO_VERSION=${{ steps.go-version.outputs.go-version }}
          cache-from: type=gha

      - name: Quick smoke test
        run: |
          docker run --rm test:${{ matrix.base }} echo "Smoke test passed"

  # Security scan on PR
  security-scan:
    runs-on: ubuntu-latest
    needs: build-test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Get Go version from config
        id: go-version
        run: |
          GO_VERSION=$(yq eval '.tools.languages.go.version' configs/image-foundry.yaml)
          echo "go-version=$GO_VERSION" >> $GITHUB_OUTPUT

      - name: Build for scan
        uses: docker/build-push-action@v5
        with:
          context: .
          file: templates/base/ubuntu-24.04.Dockerfile
          platforms: linux/amd64
          push: false
          load: true
          tags: scan-target:latest
          build-args: |
            GO_VERSION=${{ steps.go-version.outputs.go-version }}

      - name: Run Trivy scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'scan-target:latest'
          format: 'sarif'
          output: 'trivy-pr-results.sarif'
          severity: 'CRITICAL'
          exit-code: '0'  # Don't fail PR, just report

      - name: Upload scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-pr-results.sarif'
          category: trivy-pr

  # Check code quality
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.out

      - name: Run CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: go

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Analyze
        uses: github/codeql-action/analyze@v4
