# Generated Dockerfile - DO NOT EDIT MANUALLY
# Generated by: scripts/generate-dockerfiles.sh
# Base: {{ .Base }}
# Architecture: {{ .Arch }}

# Base image
FROM {{ .BaseImage }} AS base

# Common environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV PATH="/usr/local/go/bin:/go/bin:${PATH}"

# Create non-root user
RUN groupadd -r foundry && useradd -r -g foundry -m -s /bin/bash foundry

# Set working directory
WORKDIR /workspace

# Change ownership
RUN chown -R foundry:foundry /workspace

{{- if eq .Base "ubuntu-24.04" "ubuntu-22.04" }}
# Ubuntu-specific base setup
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    curl \
    wget \
    gnupg \
    jq \
    git \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean
{{- end }}

{{- if eq .Base "alpine-3.20" }}
# Alpine-specific base setup
RUN apk add --no-cache \
    ca-certificates \
    curl \
    wget \
    jq \
    git \
    bash
{{- end }}

# Layer for Go installation
FROM base AS go-layer
ARG GO_VERSION={{ .GoVersion }}
ARG TARGETARCH

RUN if [ -n "$GO_VERSION" ]; then \
    case "${TARGETARCH}" in \
        amd64) GO_ARCH="amd64" ;; \
        arm64) GO_ARCH="arm64" ;; \
        *) echo "Unsupported architecture: ${TARGETARCH}"; exit 1 ;; \
    esac && \
    curl -fsSL "https://go.dev/dl/go${GO_VERSION}.linux-${GO_ARCH}.tar.gz" -o /tmp/go.tar.gz && \
    tar -C /usr/local -xzf /tmp/go.tar.gz && \
    rm /tmp/go.tar.gz && \
    ln -s /usr/local/go/bin/go /usr/local/bin/go && \
    ln -s /usr/local/go/bin/gofmt /usr/local/bin/gofmt; \
    fi

ENV PATH=$PATH:/usr/local/go/bin
ENV GOPATH=/go
ENV GOBIN=$GOPATH/bin

{{- if .InstallNodeJS }}
# Layer for Node.js
FROM base AS nodejs-layer
ARG NODE_VERSION={{ .NodeVersion }}

{{- if eq .Base "ubuntu-24.04" "ubuntu-22.04" }}
RUN if [ -n "$NODE_VERSION" ]; then \
    curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION}.x | bash - && \
    apt-get install -y nodejs && \
    npm install -g npm@latest; \
    fi
{{- end }}

{{- if eq .Base "alpine-3.20" }}
RUN if [ -n "$NODE_VERSION" ]; then \
    apk add --no-cache nodejs npm && \
    npm install -g npm@latest; \
    fi
{{- end }}
{{- end }}

{{- if .InstallPython }}
# Layer for Python
FROM base AS python-layer
ARG PYTHON_VERSION={{ .PythonVersion }}

{{- if eq .Base "ubuntu-24.04" "ubuntu-22.04" }}
RUN if [ -n "$PYTHON_VERSION" ]; then \
    apt-get update && apt-get install -y --no-install-recommends \
    python${PYTHON_VERSION} \
    python${PYTHON_VERSION}-venv \
    python3-pip \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean; \
    fi
{{- end }}

{{- if eq .Base "alpine-3.20" }}
RUN if [ -n "$PYTHON_VERSION" ]; then \
    apk add --no-cache \
    python${PYTHON_VERSION} \
    py3-pip \
    py3-virtualenv; \
    fi
{{- end }}
{{- end }}

# Layer for security tools
FROM base AS security-layer
ARG TARGETARCH

{{- if .InstallTrivy }}
{{- if eq .Base "ubuntu-24.04" "ubuntu-22.04" }}
# Install Trivy
RUN curl -fsSL https://aquasecurity.github.io/trivy-repo/deb/public.key | gpg --dearmor -o /usr/share/keyrings/trivy.gpg && \
    echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb generic main" > /etc/apt/sources.list.d/trivy.list && \
    apt-get update && apt-get install -y trivy && rm -rf /var/lib/apt/lists/*
{{- end }}

{{- if eq .Base "alpine-3.20" }}
# Install Trivy
RUN apk add --no-cache trivy
{{- end }}
{{- end }}

{{- if .InstallCosign }}
# Install Cosign
RUN COSIGN_VERSION=$(curl -s https://api.github.com/repos/sigstore/cosign/releases/latest | grep -o '"tag_name": "v[^"]*"' | cut -d'"' -f4) && \
    case "${TARGETARCH}" in \
        amd64) COSIGN_ARCH="amd64" ;; \
        arm64) COSIGN_ARCH="arm64" ;; \
        *) COSIGN_ARCH="${TARGETARCH}" ;; \
    esac && \
    curl -fsSL -o /usr/local/bin/cosign "https://github.com/sigstore/cosign/releases/download/${COSIGN_VERSION}/cosign-linux-${COSIGN_ARCH}" && \
    chmod +x /usr/local/bin/cosign
{{- end }}

{{- if .InstallSyft }}
# Install Syft
RUN curl -fsSL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
{{- end }}

# Layer for compliance tools
FROM base AS compliance-layer
ARG TARGETARCH

{{- if .InstallCompliance }}
{{- if eq .Base "ubuntu-24.04" }}
# Install OpenSCAP for Ubuntu 24.04
RUN apt-get update && apt-get install -y --no-install-recommends \
    openscap-scanner \
    scap-security-guide \
    python3-pip \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Install OpenSCAP content for Ubuntu 24.04
RUN mkdir -p /usr/share/xml/scap/ssg/content && \
    wget -O /usr/share/xml/scap/ssg/content/ssg-ubuntu2404-xccdf.xml \
    https://github.com/ComplianceAsCode/content/releases/latest/download/ssg-ubuntu2404-xccdf.xml
{{- end }}

{{- if eq .Base "ubuntu-22.04" }}
# Install OpenSCAP for Ubuntu 22.04
RUN apt-get update && apt-get install -y --no-install-recommends \
    openscap-scanner \
    scap-security-guide \
    python3-pip \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Install OpenSCAP content for Ubuntu 22.04
RUN mkdir -p /usr/share/xml/scap/ssg/content && \
    wget -O /usr/share/xml/scap/ssg/content/ssg-ubuntu2204-xccdf.xml \
    https://github.com/ComplianceAsCode/content/releases/latest/download/ssg-ubuntu2204-xccdf.xml
{{- end }}

{{- if eq .Base "alpine-3.20" }}
# Install OpenSCAP for Alpine
RUN apk add --no-cache \
    openscap \
    python3 \
    py3-pip \
    wget \
    ca-certificates

# Install OpenSCAP content for Alpine
RUN mkdir -p /usr/share/xml/scap/ssg/content && \
    wget -O /usr/share/xml/scap/ssg/content/ssg-alpine319-xccdf.xml \
    https://github.com/ComplianceAsCode/content/releases/latest/download/ssg-alpine319-xccdf.xml
{{- end }}

# Install OPA (Open Policy Agent)
RUN OPA_VERSION=$(curl -s https://api.github.com/repos/open-policy-agent/opa/releases/latest | grep -o '"tag_name": "v[^\"]*"' | cut -d'"' -f4 | sed 's/v//') && \
    wget -O /usr/local/bin/opa "https://github.com/open-policy-agent/opa/releases/download/v${OPA_VERSION}/opa_linux_${TARGETARCH}" && \
    chmod +x /usr/local/bin/opa

# Create compliance policies directory
RUN mkdir -p /opt/compliance/policies /opt/compliance/reports

# Copy default compliance policies
COPY compliance/ /opt/compliance/policies/
{{- end }}

# Layer for DevOps tools
FROM base AS devops-layer
ARG TARGETARCH

{{- if .InstallDocker }}
{{- if eq .Base "ubuntu-24.04" "ubuntu-22.04" }}
# Install Docker CLI
RUN curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" > /etc/apt/sources.list.d/docker.list && \
    apt-get update && apt-get install -y docker-ce-cli && rm -rf /var/lib/apt/lists/*
{{- end }}

{{- if eq .Base "alpine-3.20" }}
# Install Docker CLI
RUN apk add --no-cache docker-cli
{{- end }}
{{- end }}

{{- if .InstallKubectl }}
# Install kubectl
RUN KUBECTL_VERSION={{ .KubectlVersion }} && \
    case "${TARGETARCH}" in \
        amd64) KUBECTL_ARCH="amd64" ;; \
        arm64) KUBECTL_ARCH="arm64" ;; \
        *) KUBECTL_ARCH="${TARGETARCH}" ;; \
    esac && \
    curl -fsSL -o /usr/local/bin/kubectl "https://dl.k8s.io/release/v${KUBECTL_VERSION}/bin/linux/${KUBECTL_ARCH}/kubectl" && \
    chmod +x /usr/local/bin/kubectl
{{- end }}

{{- if .InstallHelm }}
# Install helm
RUN HELM_VERSION={{ .HelmVersion }} && \
    case "${TARGETARCH}" in \
        amd64) HELM_ARCH="amd64" ;; \
        arm64) HELM_ARCH="arm64" ;; \
        *) HELM_ARCH="${TARGETARCH}" ;; \
    esac && \
    curl -fsSL "https://get.helm.sh/helm-v${HELM_VERSION}-linux-${HELM_ARCH}.tar.gz" -o /tmp/helm.tar.gz && \
    tar -xzf /tmp/helm.tar.gz -C /tmp && \
    mv /tmp/linux-${HELM_ARCH}/helm /usr/local/bin/helm && \
    rm -rf /tmp/helm.tar.gz /tmp/linux-${HELM_ARCH}
{{- end }}

{{- if .InstallTerraform }}
# Install Terraform
RUN TERRAFORM_VERSION={{ .TerraformVersion }} && \
    case "${TARGETARCH}" in \
        amd64) TERRAFORM_ARCH="amd64" ;; \
        arm64) TERRAFORM_ARCH="arm64" ;; \
        *) TERRAFORM_ARCH="${TARGETARCH}" ;; \
    esac && \
    wget -O /tmp/terraform.zip "https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_${TERRAFORM_ARCH}.zip" && \
    unzip /tmp/terraform.zip -d /usr/local/bin/ && \
    rm /tmp/terraform.zip
{{- end }}

# Final assembly
FROM base AS final

# Copy tools from layers if they were built
COPY --from=go-layer /usr/local/go /usr/local/go
COPY --from=go-layer /usr/local/bin/go* /usr/local/bin/

{{- if .InstallNodeJS }}
COPY --from=nodejs-layer /usr/bin/node /usr/bin/node
COPY --from=nodejs-layer /usr/bin/npm /usr/bin/npm
{{- end }}

{{- if .InstallTrivy }}
COPY --from=security-layer /usr/local/bin/trivy /usr/local/bin/trivy
{{- if eq .Base "alpine-3.20" }}
COPY --from=security-layer /usr/bin/trivy /usr/bin/trivy
{{- end }}
{{- end }}

{{- if .InstallCosign }}
COPY --from=security-layer /usr/local/bin/cosign /usr/local/bin/cosign
{{- end }}

{{- if .InstallSyft }}
COPY --from=security-layer /usr/local/bin/syft /usr/local/bin/syft
{{- end }}

{{- if .InstallCompliance }}
COPY --from=compliance-layer /usr/local/bin/opa /usr/local/bin/opa
COPY --from=compliance-layer /opt/compliance /opt/compliance
{{- end }}

{{- if .InstallKubectl }}
COPY --from=devops-layer /usr/local/bin/kubectl /usr/local/bin/kubectl
{{- end }}

{{- if .InstallHelm }}
COPY --from=devops-layer /usr/local/bin/helm /usr/local/bin/helm
{{- end }}

{{- if .InstallDocker }}
{{- if eq .Base "ubuntu-24.04" "ubuntu-22.04" }}
COPY --from=devops-layer /usr/bin/docker /usr/bin/docker
{{- end }}
{{- end }}

{{- if .InstallTerraform }}
COPY --from=devops-layer /usr/local/bin/terraform /usr/local/bin/terraform
{{- end }}

# Additional packages from config
{{- range .AdditionalPackages }}
{{- if eq $.Base "ubuntu-24.04" "ubuntu-22.04" }}
RUN apt-get update && apt-get install -y {{ . }} && rm -rf /var/lib/apt/lists/*
{{- end }}
{{- if eq $.Base "alpine-3.20" }}
RUN apk add --no-cache {{ . }}
{{- end }}
{{- end }}

# Labels
LABEL org.opencontainers.image.title="ImageFoundry Base Image ({{ .Base }})"
LABEL org.opencontainers.image.description="Custom-built container image with development tools"
LABEL org.opencontainers.image.version="{{ .GoVersion }}"
LABEL org.opencontainers.image.created="{{ .Timestamp }}"
LABEL org.opencontainers.image.source="https://github.com/simonbbbb/ImageFoundry"

# Switch to non-root user
USER foundry

# Default command
CMD ["/bin/bash"]
